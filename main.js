/*
SANKRYPTIDIAN v1.0 - Professional Encryption for Obsidian
Military-grade AES-256-GCM encryption for your notes
WARNING: Keep your master password safe! It cannot be recovered.
*/
var z=Object.defineProperty;var O=(k,t,e)=>t in k?z(k,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):k[t]=e;var F=(k,t,e)=>(O(k,typeof t!="symbol"?t+"":t,e),e);var x=class{static async deriveKey(t,e){let s=new TextEncoder,n=await crypto.subtle.importKey("raw",s.encode(t),"PBKDF2",!1,["deriveKey"]);return await crypto.subtle.deriveKey({name:"PBKDF2",salt:e,iterations:this.ITERATIONS,hash:"SHA-256"},n,{name:this.ALGORITHM,length:this.KEY_LENGTH},!1,["encrypt","decrypt"])}static async encrypt(t,e){try{let s=crypto.getRandomValues(new Uint8Array(16)),n=crypto.getRandomValues(new Uint8Array(12)),i=await this.deriveKey(e,s),a=new TextEncoder().encode(t),o=await crypto.subtle.encrypt({name:this.ALGORITHM,iv:n},i,a),d=1+s.length+n.length+o.byteLength,u=new Uint8Array(d);return u[0]=1,u.set(s,1),u.set(n,1+s.length),u.set(new Uint8Array(o),1+s.length+n.length),this.arrayToBase64(u)}catch(s){throw console.error("Sankrypt encryption error:",s),new Error(`Encryption failed: ${s.message}`)}}static async decrypt(t,e){try{let s=this.base64ToArray(t);if(s[0]!==1)throw new Error("Unsupported encryption version");let i=s.slice(1,17),r=s.slice(17,29),a=s.slice(29),o=await this.deriveKey(e,i),d=await crypto.subtle.decrypt({name:this.ALGORITHM,iv:r},o,a);return new TextDecoder().decode(d)}catch(s){throw console.error("Sankrypt decryption error:",s),s.message.includes("wrong key")||s.name==="OperationError"?new Error("Decryption failed: Incorrect password or corrupted data"):s}}static validatePassword(t){let e=[];return t.length<12&&e.push("Password must be at least 12 characters"),/[a-z]/.test(t)||e.push("Password must contain lowercase letters"),/[A-Z]/.test(t)||e.push("Password must contain uppercase letters"),/[0-9]/.test(t)||e.push("Password must contain numbers"),/[^a-zA-Z0-9]/.test(t)||e.push("Password must contain special characters"),{isValid:e.length===0,issues:e,strength:this.calculatePasswordStrength(t)}}static calculatePasswordStrength(t){let e=0;t.length>=12&&(e+=25),t.length>=16&&(e+=10),t.length>=20&&(e+=10),/[a-z]/.test(t)&&(e+=10),/[A-Z]/.test(t)&&(e+=10),/[0-9]/.test(t)&&(e+=10),/[^a-zA-Z0-9]/.test(t)&&(e+=15);let s=new Set(t).size;return e+=Math.min(20,s/t.length*40),Math.min(100,e)}static arrayToBase64(t){return btoa(String.fromCharCode(...t))}static base64ToArray(t){let e=atob(t),s=new Uint8Array(e.length);for(let n=0;n<e.length;n++)s[n]=e.charCodeAt(n);return s}static generatePasswordHint(t){if(!t)return"";let e=t[0],s=t[t.length-1],n=t.length;return`Starts with "${e}", ends with "${s}", ${n} chars`}};F(x,"ALGORITHM","AES-GCM"),F(x,"KEY_LENGTH",256),F(x,"ITERATIONS",31e4);var P=require("obsidian"),C={LOCK:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',UNLOCK:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',KEY:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 2.7a1 1 0 0 0-1.4 0L15.5 5"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/></svg>',SHIELD:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>',SHIELD_CHECK:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>',FOLDER:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg>',FOLDER_SEARCH:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.7 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v4.1"/><path d="m21 21-1.5-1.5"/><circle cx="17" cy="17" r="3"/></svg>',FILE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>',FILE_KEY:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><circle cx="10" cy="16" r="2"/><path d="m16 10-4.5 4.5"/><path d="m15 11 1 1"/></svg>',SEARCH:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>',EYE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10 7-10 7Z"/><circle cx="12" cy="12" r="3"/></svg>',SETTINGS:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',REFRESH:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',X_CIRCLE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></svg>',CHECK_CIRCLE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><path d="m9 11 3 3L22 4"/></svg>',ALERT_CIRCLE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',LOCK_OPEN:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',INFO:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>',HELP_CIRCLE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',DOWNLOAD:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>',UPLOAD:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>',FILTER:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>',CHECK_SQUARE:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>',BIG_LOCK:'<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',BIG_SHIELD:'<svg xmlns="http://www.w3.org/2000/svg" width="120" height="120" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>'};function R(k,t=16,e="currentColor"){let s=C[k];if(!s)return document.createElement("span");let n=document.createElement("div");n.innerHTML=s;let i=n.firstChild;return i.style.width=`${t}px`,i.style.height=`${t}px`,i.style.color=e,i.style.display="inline-block",i.style.verticalAlign="middle",i}function L(k,t="",e,s={}){let n=document.createElement("button");n.className="sankrypt-icon-button";let i=R(k,s.size||16,s.color);return n.appendChild(i),t&&(n.title=t),e&&n.addEventListener("click",e),s.style&&Object.assign(n.style,s.style),n}var D=class{constructor(t,e,s){this.app=t,this.plugin=e,this.file=s,this.container=null,this.encryptedContent=null,this.fileSize=0}async createView(){this.container=document.createElement("div"),this.container.className="sankrypt-encryption-viewer";try{this.encryptedContent=await this.app.vault.read(this.file),this.fileSize=new Blob([this.encryptedContent]).size,this.render()}catch(t){this.renderError(t)}return this.container}render(){this.container.empty();let t=document.createElement("div");t.className="sankrypt-encryption-icon",t.innerHTML=C.BIG_LOCK,this.container.appendChild(t);let e=document.createElement("h1");e.className="sankrypt-encryption-title",e.textContent="ENCRYPTED FILE",this.container.appendChild(e);let s=document.createElement("div");s.className="sankrypt-encryption-subtitle",s.textContent=`This file "${this.file.name}" is encrypted with military-grade AES-256-GCM encryption. Enter the master password to decrypt and view its contents.`,this.container.appendChild(s);let n=document.createElement("div");n.className="sankrypt-encryption-info";let i=document.createElement("h3");i.innerHTML=`${C.INFO} File Information`,n.appendChild(i);let r=document.createElement("div");r.className="sankrypt-encryption-details";let a=document.createElement("div");a.className="sankrypt-encryption-detail",a.innerHTML=`
      <span class="sankrypt-encryption-detail-label">File Name:</span>
      <span class="sankrypt-encryption-detail-value">${this.file.name.replace(".skenc","")}</span>
    `,r.appendChild(a);let o=document.createElement("div");o.className="sankrypt-encryption-detail",o.innerHTML=`
      <span class="sankrypt-encryption-detail-label">Location:</span>
      <span class="sankrypt-encryption-detail-value">${this.file.path}</span>
    `,r.appendChild(o);let d=document.createElement("div");d.className="sankrypt-encryption-detail";let u=(this.fileSize/1024).toFixed(2);d.innerHTML=`
      <span class="sankrypt-encryption-detail-label">Encrypted Size:</span>
      <span class="sankrypt-encryption-detail-value">${u} KB</span>
    `,r.appendChild(d);let h=document.createElement("div");h.className="sankrypt-encryption-detail",h.innerHTML=`
      <span class="sankrypt-encryption-detail-label">Encryption:</span>
      <span class="sankrypt-encryption-detail-value">AES-256-GCM</span>
    `,r.appendChild(h);let g=document.createElement("div");g.style.marginTop="15px",g.innerHTML=`
      <span class="sankrypt-encryption-tag">Military-Grade</span>
      <span class="sankrypt-encryption-tag">AES-256</span>
      <span class="sankrypt-encryption-tag">PBKDF2</span>
      <span class="sankrypt-encryption-tag">GCM Mode</span>
    `,r.appendChild(g),n.appendChild(r),this.container.appendChild(n);let l=document.createElement("div");l.className="sankrypt-encryption-actions";let p=document.createElement("button");p.className="sankrypt-encryption-button sankrypt-encryption-button-primary",p.innerHTML=`${C.UNLOCK} Decrypt File`,p.addEventListener("click",async()=>{await this.plugin.decryptFile(this.file)}),l.appendChild(p);let c=document.createElement("button");c.className="sankrypt-encryption-button sankrypt-encryption-button-secondary",c.innerHTML=`${C.EYE} View Encrypted Data`,c.addEventListener("click",()=>{this.showEncryptedData()}),l.appendChild(c),this.container.appendChild(l);let w=document.createElement("div");w.className="sankrypt-encryption-warning",w.innerHTML=`
      <p>${C.ALERT_CIRCLE} WARNING: Without the correct master password, this file cannot be decrypted. Keep your password safe!</p>
    `,this.container.appendChild(w)}renderError(t){this.container.empty();let e=document.createElement("div");e.className="sankrypt-encryption-icon",e.innerHTML=C.ALERT_CIRCLE,this.container.appendChild(e);let s=document.createElement("h1");s.className="sankrypt-encryption-title",s.textContent="ERROR LOADING FILE",s.style.color="#ef4444",this.container.appendChild(s);let n=document.createElement("div");n.className="sankrypt-encryption-subtitle",n.textContent=`Failed to load encrypted file: ${t.message}`,n.style.color="#ef4444",this.container.appendChild(n);let i=document.createElement("button");i.className="sankrypt-encryption-button sankrypt-encryption-button-primary",i.textContent="Retry",i.style.marginTop="20px",i.addEventListener("click",async()=>{try{this.encryptedContent=await this.app.vault.read(this.file),this.fileSize=new Blob([this.encryptedContent]).size,this.render()}catch(r){this.renderError(r)}}),this.container.appendChild(i)}showEncryptedData(){let t=new P.Modal(this.app);t.titleEl.textContent="Encrypted Data Preview";let e=t.contentEl;e.empty();let s=e.createDiv();s.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;";let n=s.createDiv();n.innerHTML=C.FILE_KEY,n.firstChild.style.width="24px",n.firstChild.style.height="24px",n.firstChild.style.color="var(--text-accent)",s.createEl("h3",{text:"Raw Encrypted Data",style:"margin: 0;"});let i=e.createEl("div",{text:"This is the encrypted binary data in Base64 format. It cannot be read without the master password.",attr:{style:"margin-bottom: 15px; padding: 10px; background: var(--background-secondary); border-radius: 6px; font-size: 13px;"}}),r=e.createEl("textarea",{attr:{readonly:!0,style:"width: 100%; height: 300px; font-family: monospace; font-size: 11px; padding: 10px; border-radius: 6px; border: 1px solid var(--background-modifier-border); background: var(--background-primary); resize: vertical;"}});if(this.encryptedContent.length>1e3){let d=this.encryptedContent.substring(0,500),u=this.encryptedContent.substring(this.encryptedContent.length-500);r.value=`${d}

[... ${this.encryptedContent.length-1e3} characters ...]

${u}`}else r.value=this.encryptedContent;e.createEl("button",{text:"Copy to Clipboard",attr:{style:"margin-top: 15px; padding: 8px 16px; float: right;"}}).addEventListener("click",()=>{navigator.clipboard.writeText(this.encryptedContent),new P.Notice("Encrypted data copied to clipboard")}),e.createEl("button",{text:"Close",attr:{style:"margin-top: 15px; padding: 8px 16px;"}}).addEventListener("click",()=>t.close()),t.open()}},T=class{constructor(t,e,s={}){this.app=t,this.title=e,this.options={isConfirm:!1,showStrength:!1,...s},this.resolve=null,this.modal=null}open(){return new Promise(t=>{this.resolve=t,this.modal=new N(this.app,this.title,this.options,this),this.modal.open()})}},N=class extends P.Modal{constructor(t,e,s,n){super(t),this.title=e,this.options=s,this.parent=n,this.password="",this.strength=0,this.input=null}onOpen(){let{contentEl:t,modalEl:e}=this;t.empty(),t.addClass("sankrypt-modal");let s=t.createDiv();s.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;";let n=s.createDiv();n.innerHTML=C.KEY,n.firstChild.style.width="24px",n.firstChild.style.height="24px",n.firstChild.style.color="var(--text-accent)",s.createEl("h2",{text:this.title,attr:{style:"margin: 0;"}});let i=t.createDiv();i.style.cssText=`
      margin-bottom: 10px;
      padding: 8px 12px;
      background: rgba(59, 130, 246, 0.1);
      border-radius: 6px;
      border-left: 3px solid #3b82f6;
      font-size: 12px;
      color: var(--text-normal);
    `,i.innerHTML=`
      <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
        ${C.INFO}
        <strong>Remember:</strong>
      </div>
      <div>The safest key is the one that exists only in your mind.</div>
    `;let r=t.createDiv();r.style.cssText="margin: 20px 0; position: relative;",this.input=r.createEl("input",{type:"password",attr:{placeholder:"Enter your key . . . ",autocomplete:"new-password",style:`
          width: 100%;
          padding: 12px 40px 12px 12px;
          font-size: 16px;
          border-radius: 6px;
          border: 1px solid var(--background-modifier-border);
          box-sizing: border-box;
        `}});let a=r.createDiv();a.innerHTML=C.EYE,a.style.cssText=`
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      cursor: pointer;
      color: var(--text-muted);
      opacity: 0.7;
      transition: opacity 0.2s ease;
    `;let o=a.firstChild;o.style.width="20px",o.style.height="20px";let d=!1;if(a.addEventListener("mouseenter",()=>{a.style.opacity="1"}),a.addEventListener("mouseleave",()=>{a.style.opacity="0.7"}),a.addEventListener("click",()=>{d=!d,this.input.type=d?"text":"password",d?o.innerHTML='<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10 7-10 7Z"/><path d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/><line x1="2" x2="22" y1="2" y2="22"/>':o.innerHTML='<path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10 7-10 7Z"/><circle cx="12" cy="12" r="3"/>'}),setTimeout(()=>{this.input.focus(),this.input.select()},10),this.options.showStrength){let l=t.createDiv();l.style.cssText="margin: 15px 0;";let p=l.createDiv();p.style.cssText=`
                height: 6px;
                background: var(--background-modifier-border);
                border-radius: 3px;
                overflow: hidden;
                margin: 5px 0;
            `;let c=p.createDiv();c.style.cssText=`
                height: 100%;
                width: 0%;
                background: #ef4444;
                transition: width 0.3s ease, background 0.3s ease;
                border-radius: 3px;
            `;let w=l.createDiv();w.style.cssText="font-size: 12px; color: var(--text-muted); display: flex; justify-content: space-between;";let v=w.createSpan({text:"Password strength:"}),f=w.createSpan({text:"None"});f.style.fontWeight="bold",this.input.addEventListener("input",()=>{let b=x.validatePassword(this.input.value);this.strength=b.strength,c.style.width=`${this.strength}%`,this.strength<40?(c.style.background="#ef4444",f.textContent="Weak",f.style.color="#ef4444"):this.strength<70?(c.style.background="#f59e0b",f.textContent="Moderate",f.style.color="#f59e0b"):this.strength<90?(c.style.background="#10b981",f.textContent="Strong",f.style.color="#10b981"):(c.style.background="#3b82f6",f.textContent="Very Strong",f.style.color="#3b82f6")})}let u=t.createDiv();u.style.cssText="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;";let h=L("X_CIRCLE","Cancel",()=>{this.close(),this.parent.resolve&&this.parent.resolve(null)},{size:18,style:{padding:"8px 16px",display:"flex",alignItems:"center",gap:"6px"}});h.innerHTML+=" Cancel";let g=L("CHECK_CIRCLE",this.options.isConfirm?"Confirm":"Submit",()=>{this.password=this.input.value,this.close(),this.parent.resolve&&this.parent.resolve(this.password)},{size:18,style:{padding:"8px 16px",display:"flex",alignItems:"center",gap:"6px",background:"var(--interactive-accent)",color:"var(--text-on-accent)",border:"none"}});g.innerHTML+=` ${this.options.isConfirm?"Confirm":"Submit"}`,u.appendChild(h),u.appendChild(g),this.input.addEventListener("keydown",l=>{l.key==="Enter"&&(this.password=this.input.value,this.close(),this.parent.resolve&&this.parent.resolve(this.password)),l.key==="Escape"&&(this.close(),this.parent.resolve&&this.parent.resolve(null))}),e.addEventListener("click",l=>{l.target===e&&(this.close(),this.parent.resolve&&this.parent.resolve(null))}),t.appendChild(u)}onClose(){let{contentEl:t}=this;t.empty(),this.parent.resolve&&!this.password&&this.parent.resolve(null)}},B=class{constructor(t,e,s){this.app=t,this.files=e,this.plugin=s,this.modal=null}open(t="decrypt"){this.modal=new H(this.app,this.files,this.plugin,t),this.modal.open()}},H=class extends P.Modal{constructor(t,e,s,n){super(t),this.files=e,this.plugin=s,this.action=n,this.selectedFiles=new Set}onOpen(){let{contentEl:t}=this;t.empty(),t.addClass("sankrypt-modal");let e=t.createDiv();e.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;";let s=e.createDiv();s.innerHTML=this.action==="decrypt"?C.FOLDER_SEARCH:C.FOLDER,s.firstChild.style.width="28px",s.firstChild.style.height="28px",s.firstChild.style.color="var(--text-accent)";let n=this.action==="decrypt"?"Decrypt Files":"Encrypted Files";e.createEl("h2",{text:`${n} (${this.files.length})`,attr:{style:"margin: 0;"}});let i=t.createDiv();i.style.cssText="margin: 15px 0; display: flex; align-items: center; gap: 10px;";let r=i.createDiv();r.innerHTML=C.SEARCH,r.firstChild.style.width="18px",r.firstChild.style.height="18px",r.firstChild.style.color="var(--text-muted)";let a=i.createEl("input",{type:"search",placeholder:"Search encrypted files...",attr:{style:"flex: 1; padding: 10px 12px; border-radius: 6px; border: 1px solid var(--background-modifier-border);"}});setTimeout(()=>a.focus(),10);let o=t.createDiv();o.style.cssText=`
            max-height: 400px;
            overflow-y: auto;
            margin: 15px 0;
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            padding: 10px;
            background: var(--background-primary);
        `,this.renderFileList(o,this.files),a.addEventListener("input",u=>{let h=u.target.value.toLowerCase(),g=this.files.filter(l=>l.name.toLowerCase().includes(h)||l.path.toLowerCase().includes(h));o.empty(),this.renderFileList(o,g)});let d=t.createDiv();if(d.style.cssText="display: flex; gap: 10px; margin-top: 20px;",this.action==="decrypt"){let u=L("UNLOCK",`Decrypt Selected (${this.selectedFiles.size})`,async()=>{this.close();for(let l of this.selectedFiles){let p=this.files.find(c=>c.path===l);p&&await this.plugin.decryptFile(p)}},{size:18,style:{padding:"10px 16px",display:"flex",alignItems:"center",gap:"8px",background:"var(--interactive-accent)",color:"var(--text-on-accent)",border:"none"}});u.disabled=this.selectedFiles.size===0;let h=L("LOCK_OPEN","Decrypt All",async()=>{this.close();for(let l of this.files)await this.plugin.decryptFile(l)},{size:18,style:{padding:"10px 16px",display:"flex",alignItems:"center",gap:"8px",background:"var(--background-secondary)",border:"1px solid var(--background-modifier-border)"}}),g=L("X_CIRCLE","Cancel",()=>this.close(),{size:18,style:{padding:"10px 16px",display:"flex",alignItems:"center",gap:"8px"}});d.appendChild(u),d.appendChild(h),d.appendChild(g)}else{let u=L("X_CIRCLE","Close",()=>this.close(),{size:18,style:{padding:"10px 16px",display:"flex",alignItems:"center",gap:"8px",marginLeft:"auto"}});d.appendChild(u)}t.appendChild(d)}renderFileList(t,e){if(e.length===0){let s=t.createDiv();s.style.cssText="text-align: center; padding: 40px 20px; color: var(--text-muted);";let n=s.createDiv();n.innerHTML=C.SEARCH,n.firstChild.style.width="48px",n.firstChild.style.height="48px",n.firstChild.style.color="var(--background-modifier-border)",n.style.marginBottom="15px",s.createEl("div",{text:"No encrypted files found",attr:{style:"font-size: 14px; font-weight: bold; margin-bottom: 5px;"}}),s.createEl("div",{text:"Try a different search term",attr:{style:"font-size: 12px;"}});return}e.forEach((s,n)=>{let i=t.createDiv();i.className="sankrypt-file-item",i.style.cssText=`
                padding: 12px;
                margin: 8px 0;
                border-radius: 8px;
                background: var(--background-secondary);
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                border: 2px solid transparent;
                transition: all 0.2s ease;
            `,this.selectedFiles.has(s.path)&&(i.style.borderColor="var(--interactive-accent)",i.style.background="var(--background-modifier-hover)");let r=i.createDiv();r.style.cssText="display: flex; align-items: center;";let a=r.createEl("input",{type:"checkbox"});a.checked=this.selectedFiles.has(s.path),a.style.cssText="width: 18px; height: 18px; cursor: pointer;",a.addEventListener("change",p=>{p.stopPropagation(),a.checked?this.selectedFiles.add(s.path):this.selectedFiles.delete(s.path),this.onOpen()});let o=i.createDiv();o.innerHTML=C.FILE_KEY,o.firstChild.style.width="20px",o.firstChild.style.height="20px",o.firstChild.style.color=this.selectedFiles.has(s.path)?"var(--interactive-accent)":"var(--text-muted)";let d=i.createDiv();d.style.flex="1",d.style.minWidth="0";let u=d.createDiv();u.style.cssText="font-weight: 600; font-size: 14px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;",u.textContent=s.name.replace(".skenc","");let h=d.createDiv();h.style.cssText="font-size: 11px; color: var(--text-muted); opacity: 0.8; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;",h.textContent=s.path;let g=i.createDiv();if(g.style.cssText="display: flex; gap: 8px; align-items: center;",this.action==="decrypt"){let p=L("UNLOCK","Decrypt this file",async c=>{c.stopPropagation(),this.close(),await this.plugin.decryptFile(s)},{size:16,style:{padding:"6px"}});g.appendChild(p)}let l=L("EYE","View encrypted content",async p=>{p.stopPropagation(),await this.app.workspace.getLeaf().openFile(s)},{size:16,style:{padding:"6px"}});g.appendChild(l),i.addEventListener("click",p=>{p.target===a||p.target.closest("button")||(this.selectedFiles.has(s.path)?this.selectedFiles.delete(s.path):this.selectedFiles.add(s.path),this.onOpen())}),i.addEventListener("mouseenter",()=>{this.selectedFiles.has(s.path)||(i.style.background="var(--background-modifier-hover)",o.firstChild.style.color="var(--text-normal)")}),i.addEventListener("mouseleave",()=>{this.selectedFiles.has(s.path)||(i.style.background="var(--background-secondary)",o.firstChild.style.color="var(--text-muted)")}),t.appendChild(i)})}onClose(){let{contentEl:t}=this;t.empty()}};var y=require("obsidian"),$={autoLockMinutes:30,rememberPassword:!1,passwordHint:"",showEncryptedInExplorer:!0,defaultAction:"remove",encryptionLevel:"aes-256-gcm"},V=class extends y.PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){let{containerEl:t}=this;t.empty();let e=t.createDiv();e.style.cssText="display: flex; align-items: center; gap: 12px; margin-bottom: 30px;";let s=e.createDiv();s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>',s.firstChild.style.color="var(--text-accent)";let n=e.createDiv();n.createEl("h1",{text:"Sankrypt",attr:{style:"margin: 0 0 5px 0;"}}),n.createEl("div",{text:"Sankrypt",attr:{style:"color: var(--text-muted); font-size: 14px;"}}),t.createEl("h2",{text:"General Settings",attr:{style:"padding-bottom: 10px; margin-top: 30px;"}});let i=new y.Setting(t).setName("Auto-lock timeout").setDesc("Automatically lock vault after X minutes of inactivity (0 = never)").addText(l=>{l.setPlaceholder("30").setValue(this.plugin.settings.autoLockMinutes.toString()).onChange(async p=>{let c=parseInt(p)||0;this.plugin.settings.autoLockMinutes=Math.max(0,c),await this.plugin.saveSettings(),this.plugin.resetAutoLockTimer()}),l.inputEl.addEventListener("focus",p=>{p.stopPropagation()})});new y.Setting(t).setName("Show encrypted files in explorer").setDesc("Display .skenc files in the file explorer").addToggle(l=>l.setValue(this.plugin.settings.showEncryptedInExplorer).onChange(async p=>{this.plugin.settings.showEncryptedInExplorer=p,await this.plugin.saveSettings(),this.plugin.applyExplorerStyles()})),new y.Setting(t).setName("Default encryption action").setDesc("What happens when you encrypt a file").addDropdown(l=>l.addOption("remove","Remove unencrypted file").addOption("ask","Ask each time").addOption("keep","Keep both files").setValue(this.plugin.settings.defaultAction).onChange(async p=>{this.plugin.settings.defaultAction=p,await this.plugin.saveSettings()}));let r=t.createDiv();r.style.cssText=`
    background: rgba(245, 158, 11, 0.1);
    border: 1px solid rgba(245, 158, 11, 0.3);
    border-radius: 8px;
    padding: 15px;
    margin: 15px 0;
`,r.createEl("div",{text:"\u26A0\uFE0F Single Master Key Policy",attr:{style:"font-weight: bold; color: #f59e0b; margin-bottom: 5px;"}}),r.createEl("div",{text:"All encrypted files must use the same master password. When changing passwords, all existing files will be re-encrypted.",attr:{style:"font-size: 13px; color: var(--text-normal);"}}),t.createEl("h2",{text:"Security",attr:{style:"padding-bottom: 10px; margin-top: 40px;"}});let a=new y.Setting(t).setName("Password hint").setDesc("A hint to help you remember your master password (not stored with password). Keep it under 100 characters for best results.").addTextArea(l=>{let p=l.setPlaceholder(`e.g., "My cat's name + year I graduated"`).setValue(this.plugin.settings.passwordHint).onChange(async m=>{m.length>100&&(m=m.substring(0,100),l.setValue(m)),this.plugin.settings.passwordHint=m,await this.plugin.saveSettings()}),c=l.inputEl,w=document.createElement("div");w.style.cssText=`
      width: 100%;
      margin-bottom: 5px;
    `,c.parentNode.insertBefore(w,c),w.appendChild(c),c.style.cssText=`
      width: 100%;
      height: 100px;
      padding: 12px;
      margin: 0;
      border-radius: 8px;
      border: 1px solid var(--background-modifier-border);
      background: var(--background-primary);
      color: var(--text-normal);
      font-size: 14px;
      font-family: var(--font-text);
      line-height: 1.5;
      resize: vertical;
      transition: all 0.2s ease;
      box-sizing: border-box;
      display: block;
    `;let v=document.createElement("div");v.style.cssText=`
      display: block;
      font-size: 12px;
      margin-top: 6px;
      padding: 0 2px;
      font-family: var(--font-text);
      text-align: right;
    `;let f=document.createElement("div");f.style.cssText=`
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    `;let b=document.createElement("span");b.style.cssText=`
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s ease;
      text-align: left;
      flex: 1;
    `;let E=document.createElement("span");E.style.cssText=`
      text-align: right;
      margin-left: 10px;
      white-space: nowrap;
    `;let A=()=>{let m=c.value.length;E.textContent=`${m}/100`,m>100?(v.style.color="#ef4444",E.style.color="#ef4444",E.style.fontWeight="bold",b.textContent="Too long - truncated to 100 characters",b.style.color="#ef4444",b.style.opacity="1",c.style.borderColor="#ef4444",c.style.boxShadow="0 0 0 2px rgba(239, 68, 68, 0.1)"):m>80?(v.style.color="#f59e0b",E.style.color="#f59e0b",E.style.fontWeight="bold",b.textContent="Approaching limit",b.style.color="#f59e0b",b.style.opacity="1",c.style.borderColor="#f59e0b",c.style.boxShadow="0 0 0 2px rgba(245, 158, 11, 0.1)"):(v.style.color="var(--text-muted)",E.style.color=m>50?"var(--text-accent)":"var(--text-muted)",E.style.fontWeight="normal",b.style.opacity="0",c.style.borderColor="var(--background-modifier-border)",c.style.boxShadow="none")};f.appendChild(b),f.appendChild(E),v.appendChild(f),w.parentNode.insertBefore(v,w.nextSibling),A(),c.addEventListener("input",()=>{if(A(),c.value.length>100){let m=c.value;c.value=m.substring(0,100);let M=new Event("input",{bubbles:!0});c.dispatchEvent(M),b.textContent="Auto-truncated to 100 characters",b.style.color="#ef4444",b.style.opacity="1",c.style.borderColor="#ef4444",setTimeout(()=>{c.value.length<=100&&(c.style.borderColor="var(--background-modifier-border)")},1e3)}}),c.addEventListener("mouseenter",()=>{c.value.length<=100&&(c.style.borderColor="var(--interactive-accent)",c.style.boxShadow="0 0 0 3px rgba(var(--interactive-accent-rgb), 0.1)")}),c.addEventListener("mouseleave",()=>{c.value.length<=100&&(c.style.borderColor="var(--background-modifier-border)",c.style.boxShadow="none")}),c.addEventListener("focus",m=>{m.stopPropagation(),c.style.outline="2px solid var(--interactive-accent)",c.style.outlineOffset="2px",c.value.length<=100&&(c.style.borderColor="var(--interactive-accent)",c.style.boxShadow="0 0 0 3px rgba(var(--interactive-accent-rgb), 0.15)")}),c.addEventListener("blur",()=>{c.style.outline="none",c.value.length<=100&&(c.style.borderColor="var(--background-modifier-border)",c.style.boxShadow="none")}),c.addEventListener("focus",m=>{m.stopPropagation()})});a.settingEl.style.cssText=`
  align-items: flex-start;
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid var(--background-modifier-border);
`;let o=a.settingEl.querySelector(".setting-item-name");o&&(o.style.cssText=`
    font-weight: 600;
    font-size: 15px;
    color: var(--text-normal);
    margin-bottom: 6px;
  `);let d=a.settingEl.querySelector(".setting-item-description");d&&(d.style.cssText=`
    font-size: 13px;
    color: var(--text-muted);
    line-height: 1.4;
    margin-bottom: 12px;
  `);let u=a.settingEl.querySelector(".setting-item-control");u&&(u.style.display="flex",u.style.flexDirection="column",u.style.alignItems="stretch",u.style.width="100%"),a.settingEl.style.alignItems="flex-start",t.createEl("h2",{text:"Advanced",attr:{style:"border-bottom: 1px solid var(--background-modifier-border); padding-bottom: 10px; margin-top: 40px; color: var(--text-error);"}});let h=t.createDiv();h.style.cssText="background: var(--background-secondary); border-radius: 8px; padding: 20px; margin: 15px 0;",new y.Setting(h).setName("Clear all passwords").setDesc("Immediately lock vault and clear all passwords from memory").addButton(l=>l.setButtonText("Lock Vault Now").setCta().onClick(()=>{this.plugin.lockVault(),new y.Notice("Vault locked. Passwords cleared from memory.")})),new y.Setting(h).setName("Reset plugin").setDesc("Clear all plugin data and settings (does not affect encrypted files)").addButton(l=>l.setButtonText("Reset Plugin").setWarning().onClick(async()=>{confirm("Are you sure? This will clear all plugin settings but NOT decrypt any files.")&&(this.plugin.settings={...$},await this.plugin.saveSettings(),this.plugin.lockVault(),this.display(),new y.Notice("Plugin reset complete"))}));let g=t.createDiv();g.style.cssText=`
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--background-modifier-border);
            text-align: center;
            font-size: 12px;
            color: var(--text-muted);
        `,g.createEl("div",{text:"Sankrypt v1.0 - Professional Encryption"}),g.createEl("div",{text:"Always remember your master password! It cannot be recovered if lost.",attr:{style:"color: var(--text-error); margin-top: 5px;"}})}},S=class extends y.ItemView{constructor(t,e){super(t),this.plugin=e,this.file=null,this.viewer=null}getViewType(){return"sankrypt-encryption-view"}getDisplayText(){return this.file?`\u{1F510} ${this.file.name}`:"Encrypted File"}getIcon(){return"lock"}async onOpen(){}async setState(t,e){if(t&&t.file){let s=this.app.vault.getAbstractFileByPath(t.file);s&&s.path.endsWith(".skenc")&&await this.setFile(s)}return super.setState(t,e)}async setFile(t){this.file=t,this.containerEl.empty(),this.containerEl.addClass("sankrypt-encryption-view-container"),this.viewer=new D(this.app,this.plugin,t);let e=await this.viewer.createView();this.containerEl.appendChild(e),this.leaf.tabHeaderInnerTitleEl.setText(`\u{1F510} ${t.name}`),this.leaf.tabHeaderInnerTitleEl.title=`Encrypted: ${t.path}`,this.leaf.view.navigation=!0}getState(){return{file:this.file?this.file.path:null,...super.getState()}}async onClose(){this.viewer=null,this.file=null}};module.exports=class extends y.Plugin{constructor(){super(...arguments),this.masterPassword=null,this.encryptedFiles=new Set,this.autoLockTimer=null,this.lastActivity=Date.now(),this.settings=$,this.encryptionViewType=null}async onload(){console.log("Sankrypt v1.0 loading..."),await this.loadSettings(),this.registerEvent(this.app.workspace.on("file-open",()=>this.recordActivity())),this.registerEvent(this.app.workspace.on("click",()=>this.recordActivity())),this.registerEvent(this.app.workspace.on("keydown",()=>this.recordActivity())),this.encryptionViewType=this.registerView("sankrypt-encryption-view",t=>new S(t,this),!0),this.registerExtensions(["skenc"],"sankrypt-encryption-view"),this.registerEvent(this.app.workspace.on("file-open",async t=>{if(t&&t.path.endsWith(".skenc")){let e=this.app.workspace.getLeavesOfType("sankrypt-encryption-view");for(let n of e){let i=n.view;if(i instanceof S&&i.file&&i.file.path===t.path){this.app.workspace.revealLeaf(n);return}}await this.app.workspace.getLeaf(!0).setViewState({type:"sankrypt-encryption-view",active:!0,state:{file:t.path}})}})),this.addRibbonIcon("shield","Sankrypt",t=>{this.showControlPanel()}),this.addCommand({id:"sankrypt-encrypt-current",name:"Encrypt current file",icon:"lock",hotkeys:[{modifiers:["Ctrl","Shift"],key:"E"}],checkCallback:t=>{let e=this.app.workspace.getActiveFile();return e&&!e.path.endsWith(".skenc")?(t||this.encryptFile(e),!0):!1}}),this.addCommand({id:"sankrypt-decrypt-current",name:"Decrypt current file",icon:"unlock",hotkeys:[{modifiers:["Ctrl","Shift"],key:"D"}],checkCallback:t=>{let e=this.app.workspace.getActiveFile(),s=!1,n=null;if(e&&e.path.endsWith(".skenc"))s=!0,n=e;else{let i=this.app.workspace.activeLeaf;if(i&&i.view instanceof S){let r=i.view;r.file&&r.file.path.endsWith(".skenc")&&(s=!0,n=r.file)}}if(n&&this.isFileBlocked(n)){if(!t){let i=Math.ceil((this.lastBlockedFile.blockedUntil-Date.now())/1e3);new y.Notice(`Decryption blocked for ${i} more seconds`)}return!1}return s?(t||this.decryptFile(n),!0):!1}}),this.addCommand({id:"sankrypt-show-files",name:"Show encrypted files",icon:"folder-search",hotkeys:[{modifiers:["Ctrl","Shift","Alt"],key:"F"}],callback:()=>this.showEncryptedFilesBrowser()}),this.addCommand({id:"sankrypt-lock-vault",name:"Lock vault",icon:"lock-open",callback:()=>this.lockVault()}),this.addCommand({id:"sankrypt-change-password",name:"Change master password",icon:"key",callback:()=>this.changeMasterPassword()}),this.statusBar=this.addStatusBarItem(),this.updateStatusBar(),this.addSettingTab(new V(this.app,this)),this.applyExplorerStyles(),this.resetAutoLockTimer(),console.log("Sankrypt v1.0 loaded successfully!"),new y.Notice("Sankrypt v1.0 loaded")}async onunload(){console.log("Sankrypt unloading..."),this.lockVault(),this.autoLockTimer&&clearInterval(this.autoLockTimer),this.blockedStatusInterval&&(clearInterval(this.blockedStatusInterval),this.blockedStatusInterval=null)}isFileBlocked(t){return this.lastBlockedFile?Date.now()>=this.lastBlockedFile.blockedUntil?(this.lastBlockedFile=null,!1):t.path===this.lastBlockedFile.filePath:!1}async loadSettings(){this.settings=Object.assign({},$,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async ensureMasterPassword(t=!1,e=!1){if(this.masterPassword&&!t)return!0;let n=this.getAllEncryptedFiles().length>0;if(n&&(t||!this.masterPassword))return await this.verifyAgainstExistingFile();this.settings.passwordHint&&!t&&!n&&await this.confirmAction("Password Hint Available",`Your saved hint: "${this.settings.passwordHint}"

Do you want to use this hint or enter a new password?`,["Use Hint","Enter New Password"])==="Enter New Password"&&(t=!0),this.masterPassword&&t&&(e=!0);let i="",r="",a=3,o=0;for(;o<a;){if(i=await new T(this.app,"Set Master Password",{showStrength:!0}).open(),!i)return!1;let u=x.validatePassword(i);if(!u.isValid){let h=u.issues.join(`
\u2022 `);if(await this.showErrorModal("Password Requirements",`Password does not meet requirements:

\u2022 ${h}

Strength: ${u.strength}/100`),o++,o>=a)return new y.Notice("Too many failed attempts. Please try again later."),!1;continue}if(!e){if(r=await new T(this.app,"Confirm Master Password",{showStrength:!1}).open(),!r)return!1;if(i!==r){o++;let g=a-o;if(new y.Notice("Passwords do not match"),sleep(1e3),g>0){if(await this.confirmAction("Passwords Don't Match","Passwords do not match. Would you like to try again?",["Try Again","Cancel"])!=="Try Again")return!1;continue}else return await this.showErrorModal("Too Many Failed Attempts","Passwords did not match after multiple attempts. Please start over."),!1}}try{let g=await x.encrypt("Sankrypt encryption test",i);if(await x.decrypt(g,i),this.masterPassword=i,this.updateStatusBar(),new y.Notice("Master password set successfully"),(!this.settings.passwordHint||t)&&!e&&!n){let l=await this.promptForHint();l&&(this.settings.passwordHint=l,await this.saveSettings())}return!0}catch(h){return console.error("Password setup error:",h),new y.Notice("Failed to set master password"),!1}}return!1}async showSuccessModal(t,e){return new Promise(s=>{new class extends y.Modal{constructor(i,r,a){super(i),this.title=r,this.message=a}onOpen(){let{contentEl:i}=this;i.empty(),i.addClass("sankrypt-modal");let r=i.createDiv();r.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;";let a=r.createDiv();a.innerHTML=C.CHECK_CIRCLE,a.firstChild.style.width="24px",a.firstChild.style.height="24px",a.firstChild.style.color="#10b981",r.createEl("h3",{text:t,attr:{style:"margin: 0; color: #10b981;"}}),i.createEl("div",{text:e,attr:{style:"white-space: pre-line; margin: 15px 0; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; border-left: 4px solid #10b981;"}});let o=i.createEl("button",{text:"OK",cls:"mod-cta",attr:{style:"float: right; padding: 8px 16px; background: #10b981;"}});o.addEventListener("click",()=>{this.close(),s()}),i.appendChild(o)}onClose(){let{contentEl:i}=this;i.empty(),s()}}(this.app,t,e).open()})}async verifyAgainstExistingFile(){let t=this.getAllEncryptedFiles();if(t.length===0)return!0;let e=t[0],s=0,n=3;for(;s<n;){let r=await new T(this.app,"Verify Master Password",{showStrength:!1,isConfirm:!0}).open();if(!r)return!1;try{let a=await this.app.vault.read(e),o=await x.decrypt(a,r);return this.masterPassword=r,this.updateStatusBar(),this.resetAutoLockTimer(),await this.showSuccessModal("Password Verified",`Successfully verified password against existing encrypted files.

You have ${t.length} encrypted file(s) that will use this master password.`),!0}catch{s++;let o=n-s;if(o>0){if(await this.confirmAction("Wrong Password",`The password doesn't match existing encrypted files.
${o} attempt(s) remaining.

Try again?`,["Try Again","Cancel"])!=="Try Again")return!1}else return await this.showErrorModal("Access Denied",`Too many failed attempts.

You must provide the correct password for existing encrypted files.`),!1}}return!1}async promptForHint(){return new Promise(t=>{new class extends y.Modal{constructor(s){super(s),this.hint=""}onOpen(){let{contentEl:s}=this;s.empty(),s.addClass("sankrypt-modal");let n=s.createDiv();n.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;";let i=n.createDiv();i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>',i.firstChild.style.color="var(--text-accent)",n.createEl("h3",{text:"Password Hint",attr:{style:"margin: 0;"}}),s.createEl("p",{text:"Create a hint to help you remember your password. This hint is stored locally and is NOT encrypted with your password."});let r=s.createEl("textarea",{attr:{placeholder:`e.g., "My first pet's name + year I graduated college"`,style:"width: 100%; height: 80px; padding: 12px; margin: 15px 0; border-radius: 6px; border: 1px solid var(--background-modifier-border); resize: vertical;"}});setTimeout(()=>r.focus(),10);let a=s.createDiv();a.style.cssText="display: flex; justify-content: flex-end; gap: 10px;";let o=a.createEl("button",{text:"Skip",attr:{style:"padding: 8px 16px;"}}),d=a.createEl("button",{text:"Save Hint",cls:"mod-cta",attr:{style:"padding: 8px 16px;"}});o.addEventListener("click",()=>{this.hint="",this.close(),t("")}),d.addEventListener("click",()=>{this.hint=r.value.trim(),this.close(),t(this.hint)}),s.appendChild(a)}onClose(){let{contentEl:s}=this;s.empty(),t(this.hint)}}(this.app).open()})}async changeMasterPassword(){if(!this.masterPassword){new y.Notice("No master password set");return}let e=await new T(this.app,"Enter Current Password").open();if(e!==this.masterPassword){let i=this.getAllEncryptedFiles();if(i.length>0)try{let r=await this.app.vault.read(i[0]);await x.decrypt(r.substring(0,200),e),this.masterPassword=e}catch{new y.Notice("Incorrect current password");return}else{new y.Notice("Incorrect current password");return}}let s=await this.promptForNewPassword();if(!s)return;if(s===e){new y.Notice("New password cannot be the same as current password");return}let n=this.getAllEncryptedFiles();if(n.length>0){if(await this.confirmAction("Re-encrypt All Files",`This will re-encrypt ${n.length} file(s) with the new password.

IMPORTANT: All files must use the same master password.`,["Re-encrypt All","Cancel"])==="Re-encrypt All"){let r=0,a=0;for(let o of n)try{let d=await this.app.vault.read(o),u=await x.decrypt(d,e),h=await x.encrypt(u,s);await this.app.vault.modify(o,h),r++}catch(d){console.error(`Failed to re-encrypt ${o.name}:`,d),a++}a>0&&await this.showErrorModal("Partial Success",`Re-encrypted ${r} files, but ${a} failed.

This may indicate that some files use different passwords.`),this.masterPassword=s,this.updateStatusBar(),new y.Notice(`Password changed. ${r} files updated.`)}}else this.masterPassword=s,this.updateStatusBar(),new y.Notice("Master password changed successfully")}async promptForNewPassword(){let e=await new T(this.app,"Set New Master Password",{showStrength:!0}).open();if(!e)return null;let s=x.validatePassword(e);if(!s.isValid){let r=s.issues.join(`
\u2022 `);return await this.showErrorModal("Password Requirements",`Password does not meet requirements:

\u2022 ${r}

Strength: ${s.strength}/100`),null}return await new T(this.app,"Confirm New Master Password",{showStrength:!1}).open()!==e?(new y.Notice("Passwords do not match"),null):e}lockVault(){this.masterPassword=null,this.updateStatusBar(),this.resetAutoLockTimer(),new y.Notice("Vault locked - Passwords cleared from memory")}getAllEncryptedFiles(){return this.app.vault.getFiles().filter(t=>t.path.endsWith(".skenc"))}async openEncryptedFile(t){let e=this.app.workspace.getLeavesOfType("sankrypt-encryption-view");for(let n of e){let i=n.view;if(i instanceof S&&i.file&&i.file.path===t.path){this.app.workspace.revealLeaf(n);return}}await this.app.workspace.getLeaf(!0).setViewState({type:"sankrypt-encryption-view",active:!0,state:{file:t.path}})}async encryptFile(t){try{if(!await this.ensureMasterPassword())return;let e=t.path+".skenc",s=this.app.vault.getAbstractFileByPath(e),n=e,i=!1;if(s){let h=this.generateRandomSuffix(4);if(n=await this.generateUniqueFilename(t.path,h,!0),await this.confirmAction("File Conflict",`An encrypted file already exists at:
${e}

Create new encrypted file at:
${n}

Proceed?`,["Create New","Cancel"])!=="Create New")return;i=!0}if(await this.confirmAction("Encrypt File",`Encrypt "${t.name}"?

Original: ${t.path}
Encrypted: ${n}`,["Encrypt","Cancel"])!=="Encrypt")return;let a=await this.app.vault.read(t),o=await x.encrypt(a,this.masterPassword);await this.app.vault.create(n,o),this.encryptedFiles.add(n);let d=this.settings.defaultAction;if(d==="ask"){let h=await this.confirmAction("Original File","What would you like to do with the original file?",["Delete It","Keep Both","Cancel"]);if(h==="Delete It")await this.app.vault.delete(t);else if(h==="Cancel"){await this.app.vault.delete(this.app.vault.getAbstractFileByPath(n));return}}else if(d==="remove"){let h=this.app.workspace.getLeavesOfType("markdown");for(let g of h)if(g.view?.file?.path===t.path){await g.detach();break}await this.app.vault.delete(t)}if(this.settings.showEncryptedInExplorer){let h=this.app.vault.getAbstractFileByPath(n);h?await this.openEncryptedFile(h):console.warn("Sankrypt: Could not find encrypted file after creation:",n)}this.updateStatusBar();let u=n.split("/").pop();i?new y.Notice(`"${t.name}" encrypted \u2192 ${u}`):new y.Notice(`"${t.name}" encrypted`)}catch(e){console.error("Sankrypt encryption error:",e),new y.Notice(`Encryption failed: ${e.message}`)}}async verifyPasswordWithOtherFiles(t){let e=this.getAllEncryptedFiles();if(e.length<=1)return;let s=0,n=0,i=Math.min(2,e.length-1);for(let r=0;r<i;r++)try{let a=e[r],o=await this.app.vault.read(a);await x.decrypt(o,t),s++}catch(a){n++,console.debug(`Sankrypt: Password verification failed for file ${r}:`,a.message)}i>0&&n>0&&s>0&&setTimeout(()=>{new y.Notice(`\u26A0\uFE0F Password works for ${s+1} file(s) but failed for ${n}.`,5e3)},1e3)}async decryptFile(t,e=null,s=0,n=null){if(n&&Date.now()<n){let a=Math.ceil((n-Date.now())/1e3);await this.showErrorModal("Too Many Failed Attempts",`Please wait ${a} seconds before trying again.`);return}try{if(!e&&(e=this.masterPassword,!e&&(e=await new T(this.app,"Enter Master Password").open(),!e)))return;let a=await this.app.vault.read(t),o=await x.decrypt(a,e);if(!this.masterPassword){this.masterPassword=e,this.updateStatusBar(),this.resetAutoLockTimer();try{await this.verifyPasswordWithOtherFiles(e)}catch(v){console.warn("Sankrypt: Non-critical password verification issue:",v.message)}}let d=t.path.replace(".skenc",""),u=this.app.vault.getAbstractFileByPath(d),h=d,g=!1;if(u){let v=this.generateRandomSuffix(4);if(h=await this.generateUniqueFilename(t.path,v,!1),await this.confirmAction("File Conflict",`A file already exists at:
${d}

Create decrypted file at:
${h}

Proceed?`,["Create New","Cancel"])!=="Create New"){new y.Notice("Decryption cancelled");return}g=!0}await this.app.vault.create(h,o),this.encryptedFiles.delete(t.path),await this.app.vault.delete(t);let l=this.app.workspace.getLeavesOfType("sankrypt-encryption-view");for(let v of l)if(v.view.file&&v.view.file.path===t.path){await v.detach();break}let p=this.app.vault.getAbstractFileByPath(h);p&&await this.app.workspace.getLeaf().openFile(p),this.updateStatusBar();let c=h.split("/").pop(),w=t.name.replace(".skenc","");g?new y.Notice(`"${w}" decrypted \u2192 ${c}`):new y.Notice(`"${w}" decrypted`)}catch(a){if(console.error("Sankrypt decryption error:",a),s<3&&(a.message.includes("wrong key")||a.message.includes("Incorrect password")||a.message.includes("OperationError")||a.message.includes("decryption failed"))){let d=3-s-1,h=await new T(this.app,`Wrong Password (${d} attempt${d!==1?"s":""} left)`,{showStrength:!1}).open();if(h)return this.decryptFile(t,h,s+1,n);new y.Notice("Decryption cancelled");return}if(s>=3){let o=Date.now()+6e4;await this.showErrorModal("Too Many Failed Attempts",`Decryption is temporarily blocked for 1 minute.

Security measures:
\u2022 3 failed password attempts detected
\u2022 60-second timeout activated
\u2022 This prevents brute-force attacks

Please try again after the timeout expires.`),this.lastBlockedFile={filePath:t.path,blockedUntil:o},this.showBlockedStatus(t,o);return}new y.Notice("Decryption failed. File may be corrupted or wrong password.")}}async checkPasswordConsistency(t){let e=this.getAllEncryptedFiles(),s=0,n=0,i=e.slice(0,Math.min(3,e.length));for(let r of i)try{let a=await this.app.vault.read(r);await x.decrypt(a.substring(0,200),t),s++}catch{n++}return{consistent:n===0,workingCount:s,failedCount:n,totalFiles:e.length}}showBlockedStatus(t,e){this.blockedStatusInterval&&clearInterval(this.blockedStatusInterval);let s=()=>{let n=Date.now();if(n>=e){this.blockedStatusInterval&&(clearInterval(this.blockedStatusInterval),this.blockedStatusInterval=null),this.updateStatusBar();return}let i=Math.ceil((e-n)/1e3);if(this.statusBar){this.statusBar.empty();let r=document.createElement("div");r.style.cssText=`
        display: flex;
        align-items: center;
        gap: 8px;
        cursor: pointer;
        padding: 2px 6px;
        border-radius: 4px;
        background: rgba(239, 68, 68, 0.1);
        border: 1px solid rgba(239, 68, 68, 0.3);
      `;let a=r.createDiv();a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',a.firstChild.style.color="#ef4444";let o=r.createElement("span");o.style.cssText="font-size: 12px; font-weight: 500; color: #ef4444;",o.textContent=`Blocked (${i}s)`,r.appendChild(a),r.appendChild(o),this.statusBar.appendChild(r),r.onclick=()=>{this.showErrorModal("Decryption Blocked",`Decryption attempts are temporarily blocked.

\u2022 File: ${t.name}
\u2022 Time remaining: ${i} seconds
\u2022 Reason: Too many failed password attempts`)}}};s(),this.blockedStatusInterval=setInterval(s,1e3)}updateStatusBar(){let t=this.getAllEncryptedFiles();this.statusBar.empty();let e=document.createElement("div");e.style.cssText="display: flex; align-items: center; gap: 8px; cursor: pointer; padding: 2px 6px; border-radius: 4px;",e.addEventListener("mouseenter",()=>{e.style.background="var(--background-modifier-hover)"}),e.addEventListener("mouseleave",()=>{e.style.background="transparent"});let s=document.createElement("div");this.masterPassword?(s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>',s.firstChild.style.color="var(--text-accent)"):(s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',s.firstChild.style.color="var(--text-muted)");let n=document.createElement("span");n.style.fontSize="12px",n.style.fontWeight="500",this.masterPassword?(n.textContent=`${t.length} enc`,n.style.color="var(--text-accent)",e.title=`Sankrypt: Master password set
${t.length} encrypted files
Click for menu`):(n.textContent="Sankrypt",n.style.color="var(--text-muted)",e.title=`Sankrypt: No master password set
Click to set password`),e.appendChild(s),e.appendChild(n),this.statusBar.appendChild(e),e.onclick=()=>this.showControlPanel()}async showEncryptedFilesBrowser(){let t=this.getAllEncryptedFiles();if(t.length===0){new y.Notice("No encrypted files found");return}new B(this.app,t,this).open("decrypt")}showControlPanel(){new class extends y.Modal{constructor(e,s){super(e),this.plugin=s}onOpen(){let{contentEl:e}=this;e.empty(),e.addClass("sankrypt-control-panel");let s=e.createDiv();s.style.cssText="text-align: center; margin-bottom: 30px;";let n=s.createDiv();n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/></svg>',n.firstChild.style.color="var(--text-accent)",n.style.marginBottom="15px",s.createEl("h1",{text:"Sankrypt",attr:{style:"margin: 0 0 8px 0; color: var(--text-accent);"}}),s.createEl("div",{text:"Professional Encryption for Obsidian",attr:{style:"color: var(--text-muted); font-size: 14px; margin-bottom: 20px;"}});let i=this.plugin.getAllEncryptedFiles(),r=e.createDiv();r.style.cssText=`
                    background: var(--background-secondary);
                    border-radius: 10px;
                    padding: 20px;
                    margin: 0 0 30px 0;
                    border-left: 4px solid ${this.plugin.masterPassword?"#10b981":"#ef4444"};
                    display: flex;
                    align-items: center;
                    gap: 15px;
                `;let a=r.createDiv();this.plugin.masterPassword?(a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 13c0 5-3.5 7.5-7.66 8.95a1 1 0 0 1-.67-.01C7.5 20.5 4 18 4 13V6a1 1 0 0 1 1-1c2 0 4.5-1.2 6.24-2.72a1.17 1.17 0 0 1 1.52 0C14.51 3.81 17 5 19 5a1 1 0 0 1 1 1z"/><path d="m9 12 2 2 4-4"/></svg>',a.firstChild.style.color="#10b981"):(a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',a.firstChild.style.color="#ef4444");let o=r.createDiv();o.style.flex="1",this.plugin.masterPassword?(o.createEl("div",{text:"Master password set",attr:{style:"font-weight: bold; font-size: 16px; color: #10b981; margin-bottom: 5px;"}}),o.createEl("div",{text:`${i.length} encrypted files`,attr:{style:"font-size: 14px; color: var(--text-normal); margin-bottom: 5px;"}}),this.plugin.settings.passwordHint&&o.createEl("div",{text:`Hint: ${this.plugin.settings.passwordHint}`,attr:{style:"font-size: 12px; color: var(--text-muted); font-style: italic;"}})):(o.createEl("div",{text:"No master password set",attr:{style:"font-weight: bold; font-size: 16px; color: #ef4444; margin-bottom: 5px;"}}),o.createEl("div",{text:"Set a master password to start encrypting files",attr:{style:"font-size: 14px; color: var(--text-normal);"}})),e.createEl("h3",{text:"Quick Actions",attr:{style:"margin: 0 0 15px 0; font-size: 16px; color: var(--text-normal);"}});let d=e.createDiv();d.style.cssText="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; margin: 0 0 30px 0;",[{icon:this.plugin.masterPassword?'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m15.5 7.5 2.3 2.3a1 1 0 0 0 1.4 0l2.1-2.1a1 1 0 0 0 0-1.4L19 2.7a1 1 0 0 0-1.4 0L15.5 5"/><path d="m21 2-9.6 9.6"/><circle cx="7.5" cy="15.5" r="5.5"/></svg>',title:this.plugin.masterPassword?"Encrypt Current":"Set Password",desc:this.plugin.masterPassword?"Encrypt the currently open file":"Set a master password to begin",action:()=>{if(this.close(),this.plugin.masterPassword){let l=this.plugin.app.workspace.getActiveFile();l&&this.plugin.encryptFile(l)}else this.plugin.ensureMasterPassword()},color:this.plugin.masterPassword?"var(--text-normal)":"var(--interactive-accent)"},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',title:"Decrypt Current",desc:"Decrypt the currently open file",hotkey:"Ctrl+Shift+D",action:()=>{this.close();let p=this.plugin.app.workspace.getActiveFile();if(!p||!p.path.endsWith(".skenc")){let c=this.plugin.app.workspace.activeLeaf;if(c&&c.view instanceof S){let w=c.view;w.file&&w.file.path.endsWith(".skenc")&&(p=w.file)}}if(p&&p.path.endsWith(".skenc"))if(this.plugin.isFileBlocked(p)){let c=Math.ceil((this.plugin.lastBlockedFile.blockedUntil-Date.now())/1e3);new y.Notice(`Decryption blocked for ${c} more seconds`),this.plugin.showErrorModal("Decryption Blocked",`This file is temporarily blocked from decryption attempts.

\u2022 File: ${p.name}
\u2022 Blocked for: ${c} seconds
\u2022 Reason: Too many failed password attempts

Please wait and try again.`)}else this.plugin.decryptFile(p);else new y.Notice("No encrypted file is currently open")},color:"var(--text-normal)",disabled:!this.plugin.masterPassword},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M10.7 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v4.1"/><path d="m21 21-1.5-1.5"/><circle cx="17" cy="17" r="3"/></svg>',title:"Browse Files",desc:"View and manage all encrypted files",action:()=>{this.close(),this.plugin.showEncryptedFilesBrowser()},color:"var(--text-normal)"},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',title:"Settings",desc:"Configure plugin settings",action:()=>{this.close(),this.plugin.app.setting.open(),this.plugin.app.setting.openTabById("sankrypt")},color:"var(--text-normal)"},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',title:"Change Password",desc:"Change your master password",action:()=>{this.close(),this.plugin.changeMasterPassword()},color:"var(--text-normal)",disabled:!this.plugin.masterPassword},{icon:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 9.9-1"/></svg>',title:"Lock Vault",desc:"Clear passwords from memory",action:()=>{this.close(),this.plugin.lockVault()},color:"var(--text-error)",disabled:!this.plugin.masterPassword}].forEach(l=>{let p=d.createDiv(),c=!1,w=0;if(l.title==="Decrypt Current"){let m=this.plugin.app.workspace.getActiveFile();if(!m||!m.path.endsWith(".skenc")){let M=this.plugin.app.workspace.activeLeaf;if(M&&M.view instanceof S){let I=M.view;I.file&&I.file.path.endsWith(".skenc")&&(m=I.file)}}m&&m.path.endsWith(".skenc")&&this.plugin.isFileBlocked(m)&&(c=!0,w=Math.ceil((this.plugin.lastBlockedFile.blockedUntil-Date.now())/1e3))}p.style.cssText=`
    padding: 16px;
    background: var(--background-primary);
    border: 1px solid var(--background-modifier-border);
    border-radius: 8px;
    cursor: ${l.disabled||c?"not-allowed":"pointer"};
    opacity: ${l.disabled||c?.5:1};
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    text-align: center;
    position: relative;
    ${c?"border-color: #ef4444; background: rgba(239, 68, 68, 0.05);":""}
  `;let v=p.createDiv();v.innerHTML=l.icon;let f=v.firstChild;f.style.width="28px",f.style.height="28px",f.style.marginBottom="10px",f.style.color=l.disabled||c?"var(--text-muted)":l.color;let b=p.createDiv();b.style.cssText="font-weight: 600; font-size: 13px; margin-bottom: 4px;",b.textContent=l.title,c&&(b.style.color="#ef4444");let E=p.createDiv();E.style.cssText="font-size: 11px; color: var(--text-muted); line-height: 1.3; margin-bottom: 4px;",c?(E.textContent=`Blocked for ${w}s - Too many attempts`,E.style.color="#ef4444",E.style.fontWeight="600"):E.textContent=l.desc,!l.disabled&&!c?(p.addEventListener("mouseenter",()=>{p.style.background="var(--background-modifier-hover)",p.style.borderColor="var(--interactive-accent)",f.style.color="var(--interactive-accent)"}),p.addEventListener("mouseleave",()=>{p.style.background="var(--background-primary)",p.style.borderColor="var(--background-modifier-border)",f.style.color=l.color}),p.addEventListener("click",l.action)):c&&(p.title=`Decryption blocked for ${w} seconds
Too many failed password attempts`,p.addEventListener("mouseenter",()=>{p.style.background="rgba(239, 68, 68, 0.1)",p.style.borderColor="#ef4444"}),p.addEventListener("mouseleave",()=>{p.style.background="rgba(239, 68, 68, 0.05)",p.style.borderColor="#ef4444"}))}),e.appendChild(d);let h=e.createDiv();h.style.cssText=`
                    margin-top: 30px;
                    padding-top: 20px;
                    border-top: 1px solid var(--background-modifier-border);
                    text-align: center;
                    font-size: 11px;
                    color: var(--text-muted);
                `,h.createEl("div",{text:"Hotkeys: Ctrl+Shift+E (Encrypt) | Ctrl+Shift+D (Decrypt) | Ctrl+Shift+Alt+F (Browse)"}),h.createEl("div",{text:"Always remember your master password! It cannot be recovered if lost.",attr:{style:"color: var(--text-error); margin-top: 5px; font-weight: bold;"}});let g=e.createEl("button",{text:"Close",attr:{style:"width: 100%; margin-top: 15px; padding: 10px; background: var(--background-secondary); border: 1px solid var(--background-modifier-border); border-radius: 6px;"}});g.addEventListener("click",()=>this.close()),e.appendChild(g)}onClose(){let{contentEl:e}=this;e.empty()}}(this.app,this).open()}generateRandomSuffix(t=4){let e="abcdefghijklmnopqrstuvwxyz0123456789",s="";for(let n=0;n<t;n++)s+=e.charAt(Math.floor(Math.random()*e.length));return s}async generateUniqueFilename(t,e="",s=!1){let n=this.app.vault,i=t.split("/"),r=i.pop(),a=i.join("/")||"",o,d;if(s){let l=r.replace(/\.skenc$/,""),p=l.lastIndexOf(".");p===-1?(o=l,d=".skenc"):(o=l.substring(0,p),d=l.substring(p)+".skenc")}else if(r.endsWith(".skenc")){let l=r.slice(0,-6),p=l.lastIndexOf(".");p===-1?(o=l,d=""):(o=l.substring(0,p),d=l.substring(p))}else{let l=r.lastIndexOf(".");l===-1?(o=r,d=""):(o=r.substring(0,l),d=r.substring(l))}let u=1,h=(l,p,c=null)=>{let w=l;return p&&(w+=`-${p}`),c!==null&&(w+=`-${c}`),w+=d,a?`${a}/${w}`:w};if(!e){let l=h(o,"");if(!n.getAbstractFileByPath(l))return l}let g=h(o,e);if(!n.getAbstractFileByPath(g))return g;for(;;){let l=h(o,e,u);if(!n.getAbstractFileByPath(l))return l;if(u++,u>100)throw new Error("Could not find unique filename after 100 attempts")}}applyExplorerStyles(){let t=document.getElementById("sankrypt-explorer-styles");if(t&&t.remove(),this.settings.showEncryptedInExplorer){let e=document.createElement("style");e.id="sankrypt-explorer-styles",e.textContent=`
                .nav-file-title[data-path$=".skenc"] {
                    color: var(--text-accent) !important;
                    font-weight: 500 !important;
                }
                .nav-file-title[data-path$=".skenc"]:before {
                    content: "";
                    display: inline-block;
                    width: 14px;
                    height: 14px;
                    margin-right: 6px;
                    vertical-align: text-bottom;
                    background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>');
                    background-repeat: no-repeat;
                    opacity: 0.7;
                }
                .nav-file-title[data-path$=".skenc"]:hover {
                    background-color: var(--background-modifier-hover) !important;
                }
                .nav-file-title[data-path$=".skenc"].is-active {
                    background-color: var(--interactive-accent) !important;
                    color: var(--text-on-accent) !important;
                }
            `,document.head.appendChild(e)}}recordActivity(){this.lastActivity=Date.now()}resetAutoLockTimer(){this.autoLockTimer&&clearInterval(this.autoLockTimer),this.settings.autoLockMinutes>0&&this.masterPassword&&(this.autoLockTimer=setInterval(()=>{(Date.now()-this.lastActivity)/6e4>=this.settings.autoLockMinutes&&(this.lockVault(),new y.Notice("Vault auto-locked due to inactivity"))},6e4))}async confirmAction(t,e,s=["OK","Cancel"]){return new Promise(n=>{new class extends y.Modal{constructor(r,a,o,d){super(r),this.title=a,this.message=o,this.buttons=d,this.result=null,this.isClosed=!1}onOpen(){let{contentEl:r}=this;r.empty(),r.addClass("sankrypt-modal"),r.createEl("h3",{text:this.title});let a=r.createEl("div");a.style.cssText="margin: 15px 0; white-space: pre-line; line-height: 1.5;",a.textContent=this.message;let o=r.createDiv();o.style.cssText="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;",this.buttons.forEach(d=>{let u=o.createEl("button",{text:d,attr:{style:"padding: 8px 16px;"}});d==="Cancel"||d==="No"?u.addEventListener("click",()=>{this.result=d,this.close(),n(d)}):(u.classList.add("mod-cta"),u.addEventListener("click",()=>{this.result=d,this.close(),n(d)}))}),r.appendChild(o),this.modalEl.addEventListener("click",d=>{d.target===this.modalEl&&!this.isClosed&&(this.result="Cancel",this.close(),n("Cancel"))})}onClose(){let{contentEl:r}=this;this.isClosed=!0,r.empty(),!this.result&&this.buttons.includes("Cancel")?n("Cancel"):this.result||n(this.buttons[0])}}(this.app,t,e,s).open()})}async showErrorModal(t,e){return new Promise(s=>{new class extends y.Modal{constructor(i,r,a){super(i),this.title=r,this.message=a}onOpen(){let{contentEl:i}=this;i.empty(),i.addClass("sankrypt-modal");let r=i.createDiv();r.style.cssText="display: flex; align-items: center; gap: 10px; margin-bottom: 20px;";let a=r.createDiv();a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>',a.firstChild.style.color="#ef4444",r.createEl("h3",{text:t,attr:{style:"margin: 0; color: #ef4444;"}});let o=i.createEl("div",{text:e,attr:{style:"white-space: pre-line; margin: 15px 0; padding: 15px; background: var(--background-secondary); border-radius: 6px; border-left: 4px solid #ef4444;"}}),d=i.createEl("button",{text:"OK",cls:"mod-cta",attr:{style:"float: right; padding: 8px 16px;"}});d.addEventListener("click",()=>{this.close(),s()}),i.appendChild(d)}onClose(){let{contentEl:i}=this;i.empty(),s()}}(this.app,t,e).open()})}};
